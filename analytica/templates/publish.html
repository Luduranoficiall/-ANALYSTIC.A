{% extends "base.html" %}

{% block title %}Publicar & Compartilhar - ANALYSTIC.A{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/powerbi.css">
<style>
    .publish-container {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .publish-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
    }
    
    .publish-header h1 {
        color: var(--text-primary);
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .publish-header h1 i {
        background: linear-gradient(135deg, var(--accent-color), #f093fb);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .publish-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 30px;
    }
    
    /* Relatórios para publicar */
    .reports-section {
        background: var(--card-bg);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }
    
    .section-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .section-header h2 {
        color: var(--text-primary);
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-header h2 i {
        color: var(--accent-color);
    }
    
    .reports-list {
        padding: 20px;
    }
    
    .report-card {
        background: var(--dark-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s;
    }
    
    .report-card:hover {
        border-color: var(--accent-color);
        transform: translateX(5px);
    }
    
    .report-thumb {
        width: 120px;
        height: 80px;
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: var(--accent-color);
    }
    
    .report-info {
        flex: 1;
    }
    
    .report-name {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 15px;
        margin-bottom: 5px;
    }
    
    .report-meta {
        color: var(--text-secondary);
        font-size: 12px;
        display: flex;
        gap: 15px;
    }
    
    .report-meta span {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .report-status {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
    }
    
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
    }
    
    .status-badge.published {
        background: rgba(0,212,170,0.2);
        color: #00d4aa;
    }
    
    .status-badge.draft {
        background: rgba(255,193,7,0.2);
        color: #ffc107;
    }
    
    .publish-btn {
        background: linear-gradient(135deg, var(--accent-color), #f093fb);
        border: none;
        color: white;
        padding: 8px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
    }
    
    .publish-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(102,126,234,0.4);
    }
    
    /* Painel de Compartilhamento */
    .share-panel {
        background: var(--card-bg);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        position: sticky;
        top: 20px;
    }
    
    .share-panel-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .share-panel-header h2 {
        color: var(--text-primary);
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .share-content {
        padding: 20px;
    }
    
    .share-type {
        margin-bottom: 20px;
    }
    
    .share-type-label {
        color: var(--text-secondary);
        font-size: 12px;
        margin-bottom: 10px;
        display: block;
    }
    
    .share-options {
        display: flex;
        gap: 10px;
    }
    
    .share-option {
        flex: 1;
        background: var(--dark-bg);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 15px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s;
    }
    
    .share-option:hover,
    .share-option.active {
        border-color: var(--accent-color);
    }
    
    .share-option.active {
        background: rgba(102,126,234,0.1);
    }
    
    .share-option i {
        font-size: 24px;
        margin-bottom: 8px;
        background: linear-gradient(135deg, var(--accent-color), #f093fb);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .share-option span {
        display: block;
        color: var(--text-primary);
        font-size: 12px;
        font-weight: 600;
    }
    
    .share-link-section {
        margin-top: 25px;
    }
    
    .share-link-label {
        color: var(--text-secondary);
        font-size: 12px;
        margin-bottom: 10px;
        display: block;
    }
    
    .share-link-input {
        display: flex;
        gap: 10px;
    }
    
    .share-link-input input {
        flex: 1;
        background: var(--dark-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        color: var(--text-primary);
        font-size: 13px;
    }
    
    .copy-btn {
        background: var(--accent-color);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .copy-btn:hover {
        background: #5a6fd6;
    }
    
    /* Embed code */
    .embed-section {
        margin-top: 25px;
    }
    
    .embed-code {
        background: var(--dark-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        font-family: 'Fira Code', monospace;
        font-size: 11px;
        color: var(--accent-color);
        word-break: break-all;
        margin-bottom: 10px;
    }
    
    /* Configurações de privacidade */
    .privacy-section {
        margin-top: 25px;
        padding-top: 25px;
        border-top: 1px solid var(--border-color);
    }
    
    .privacy-label {
        color: var(--text-secondary);
        font-size: 12px;
        margin-bottom: 15px;
        display: block;
    }
    
    .privacy-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: var(--dark-bg);
        border-radius: 8px;
        margin-bottom: 10px;
    }
    
    .privacy-option-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .privacy-option-info i {
        color: var(--accent-color);
        font-size: 16px;
    }
    
    .privacy-option-info span {
        color: var(--text-primary);
        font-size: 13px;
    }
    
    .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--border-color);
        border-radius: 26px;
        transition: 0.3s;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
    }
    
    input:checked + .toggle-slider {
        background: var(--accent-color);
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }
    
    /* Senha de proteção */
    .password-section {
        margin-top: 15px;
        padding: 15px;
        background: var(--dark-bg);
        border-radius: 8px;
        display: none;
    }
    
    .password-section.active {
        display: block;
    }
    
    .password-input {
        width: 100%;
        padding: 12px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 13px;
    }
    
    /* Relatórios publicados */
    .published-section {
        margin-top: 30px;
    }
    
    .published-item {
        background: var(--dark-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .published-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .published-info i {
        color: #00d4aa;
        font-size: 16px;
    }
    
    .published-name {
        color: var(--text-primary);
        font-size: 13px;
        font-weight: 600;
    }
    
    .published-date {
        color: var(--text-secondary);
        font-size: 11px;
    }
    
    .published-actions {
        display: flex;
        gap: 8px;
    }
    
    .action-btn {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .action-btn:hover {
        border-color: var(--accent-color);
        color: var(--accent-color);
    }
    
    /* QR Code */
    .qr-section {
        margin-top: 25px;
        text-align: center;
    }
    
    .qr-code {
        width: 150px;
        height: 150px;
        background: white;
        border-radius: 12px;
        margin: 0 auto 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
    }
    
    .qr-code img {
        width: 100%;
        height: 100%;
    }
    
    .qr-label {
        color: var(--text-secondary);
        font-size: 12px;
    }
    
    /* Modal de Publicação */
    .publish-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .publish-modal.active {
        display: flex;
    }
    
    .publish-modal-content {
        background: var(--card-bg);
        border-radius: 16px;
        width: 500px;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .modal-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .modal-header h3 {
        color: var(--text-primary);
        font-size: 16px;
    }
    
    .modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 20px;
        cursor: pointer;
    }
    
    .modal-body {
        padding: 25px;
    }
    
    .success-icon {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .success-icon i {
        font-size: 60px;
        background: linear-gradient(135deg, #00d4aa, #00b894);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .success-message {
        text-align: center;
        color: var(--text-primary);
        font-size: 18px;
        margin-bottom: 25px;
    }
    
    .share-links {
        background: var(--dark-bg);
        border-radius: 12px;
        padding: 20px;
    }
    
    .share-link-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .share-link-row:last-child {
        margin-bottom: 0;
    }
    
    .share-link-row input {
        flex: 1;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        color: var(--text-primary);
        font-size: 12px;
    }
    
    .copy-link-btn {
        background: var(--accent-color);
        border: none;
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .modal-footer {
        padding: 20px;
        border-top: 1px solid var(--border-color);
        text-align: center;
    }
    
    .close-modal-btn {
        background: linear-gradient(135deg, var(--accent-color), #f093fb);
        border: none;
        color: white;
        padding: 12px 40px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="publish-container">
    <div class="publish-header">
        <h1><i class="fas fa-cloud-upload-alt"></i> Publicar & Compartilhar</h1>
    </div>
    
    <div class="publish-grid">
        <!-- Relatórios -->
        <div class="reports-section">
            <div class="section-header">
                <h2><i class="fas fa-file-alt"></i> Meus Relatórios</h2>
                <div class="header-actions">
                    <select style="background: var(--dark-bg); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 6px; color: var(--text-primary); font-size: 12px;">
                        <option>Todos</option>
                        <option>Publicados</option>
                        <option>Rascunhos</option>
                    </select>
                </div>
            </div>
            
            <div class="reports-list" id="reportsList">
                <!-- Relatórios carregados via JS -->
            </div>
        </div>
        
        <!-- Painel de Compartilhamento -->
        <div class="share-panel">
            <div class="share-panel-header">
                <h2><i class="fas fa-share-alt"></i> Compartilhamento</h2>
            </div>
            
            <div class="share-content">
                <div class="share-type">
                    <span class="share-type-label">Tipo de Compartilhamento</span>
                    <div class="share-options">
                        <div class="share-option active" data-type="link">
                            <i class="fas fa-link"></i>
                            <span>Link</span>
                        </div>
                        <div class="share-option" data-type="embed">
                            <i class="fas fa-code"></i>
                            <span>Embed</span>
                        </div>
                        <div class="share-option" data-type="email">
                            <i class="fas fa-envelope"></i>
                            <span>Email</span>
                        </div>
                    </div>
                </div>
                
                <div class="share-link-section">
                    <span class="share-link-label">Link de Compartilhamento</span>
                    <div class="share-link-input">
                        <input type="text" id="shareLink" value="Selecione um relatório para compartilhar" readonly>
                        <button class="copy-btn" onclick="copyLink()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="embed-section" id="embedSection" style="display: none;">
                    <span class="share-link-label">Código de Embed</span>
                    <div class="embed-code" id="embedCode">
                        &lt;iframe src="/embed/..." width="100%" height="600"&gt;&lt;/iframe&gt;
                    </div>
                    <button class="copy-btn" onclick="copyEmbed()" style="width: 100%; justify-content: center;">
                        <i class="fas fa-copy"></i> Copiar Código
                    </button>
                </div>
                
                <div class="privacy-section">
                    <span class="privacy-label">Configurações de Privacidade</span>
                    
                    <div class="privacy-option">
                        <div class="privacy-option-info">
                            <i class="fas fa-globe"></i>
                            <span>Público</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="togglePublic">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="privacy-option">
                        <div class="privacy-option-info">
                            <i class="fas fa-lock"></i>
                            <span>Proteção por Senha</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="togglePassword" onchange="togglePasswordSection()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="password-section" id="passwordSection">
                        <input type="password" class="password-input" placeholder="Digite a senha de acesso" id="accessPassword">
                    </div>
                    
                    <div class="privacy-option">
                        <div class="privacy-option-info">
                            <i class="fas fa-clock"></i>
                            <span>Link Expira</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleExpire">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="qr-section">
                    <div class="qr-code" id="qrCode">
                        <i class="fas fa-qrcode" style="font-size: 80px; color: #ccc;"></i>
                    </div>
                    <span class="qr-label">QR Code de Acesso</span>
                </div>
                
                <div class="published-section">
                    <span class="privacy-label">Publicações Recentes</span>
                    <div id="publishedList">
                        <!-- Lista de publicações -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Sucesso -->
<div class="publish-modal" id="publishModal">
    <div class="publish-modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-check-circle"></i> Publicação Concluída</h3>
            <button class="modal-close" onclick="closePublishModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <p class="success-message">Seu relatório foi publicado com sucesso!</p>
            
            <div class="share-links">
                <div class="share-link-row">
                    <input type="text" id="modalShareLink" readonly>
                    <button class="copy-link-btn" onclick="copyModalLink()">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <div class="share-link-row">
                    <input type="text" id="modalEmbedCode" readonly>
                    <button class="copy-link-btn" onclick="copyModalEmbed()">
                        <i class="fas fa-code"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="close-modal-btn" onclick="closePublishModal()">Fechar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dados de exemplo
const reports = [
    {
        id: 'rpt-1',
        name: 'Dashboard Financeiro Q4',
        type: 'Dashboard',
        updated: '2024-01-20',
        views: 1250,
        status: 'published',
        shareId: 'abc123def456'
    },
    {
        id: 'rpt-2',
        name: 'Análise de Vendas Regional',
        type: 'Relatório',
        updated: '2024-01-18',
        views: 890,
        status: 'draft'
    },
    {
        id: 'rpt-3',
        name: 'KPIs Marketing Digital',
        type: 'Dashboard',
        updated: '2024-01-15',
        views: 2100,
        status: 'published',
        shareId: 'xyz789ghi012'
    },
    {
        id: 'rpt-4',
        name: 'Forecast 2024',
        type: 'Relatório',
        updated: '2024-01-10',
        views: 450,
        status: 'draft'
    }
];

let selectedReport = null;

// Renderizar relatórios
function renderReports() {
    const container = document.getElementById('reportsList');
    container.innerHTML = '';
    
    reports.forEach(report => {
        const card = document.createElement('div');
        card.className = 'report-card';
        card.onclick = () => selectReport(report);
        
        card.innerHTML = `
            <div class="report-thumb">
                <i class="fas fa-${report.type === 'Dashboard' ? 'chart-pie' : 'file-alt'}"></i>
            </div>
            <div class="report-info">
                <div class="report-name">${report.name}</div>
                <div class="report-meta">
                    <span><i class="fas fa-folder"></i> ${report.type}</span>
                    <span><i class="fas fa-calendar"></i> ${report.updated}</span>
                    <span><i class="fas fa-eye"></i> ${report.views.toLocaleString()}</span>
                </div>
            </div>
            <div class="report-status">
                <span class="status-badge ${report.status}">${report.status === 'published' ? 'Publicado' : 'Rascunho'}</span>
                <button class="publish-btn" onclick="event.stopPropagation(); publishReport('${report.id}')">
                    <i class="fas fa-${report.status === 'published' ? 'sync' : 'cloud-upload-alt'}"></i>
                    ${report.status === 'published' ? 'Atualizar' : 'Publicar'}
                </button>
            </div>
        `;
        
        container.appendChild(card);
    });
}

// Selecionar relatório
function selectReport(report) {
    selectedReport = report;
    
    // Atualizar cards
    document.querySelectorAll('.report-card').forEach(card => {
        card.style.borderColor = 'var(--border-color)';
    });
    event.currentTarget.style.borderColor = 'var(--accent-color)';
    
    // Atualizar link
    if (report.shareId) {
        document.getElementById('shareLink').value = `${window.location.origin}/shared/${report.shareId}`;
        document.getElementById('embedCode').textContent = `<iframe src="${window.location.origin}/embed/${report.shareId}" width="100%" height="600"></iframe>`;
    } else {
        document.getElementById('shareLink').value = 'Publique este relatório para obter um link';
        document.getElementById('embedCode').textContent = 'Publique para obter código de embed';
    }
}

// Publicar relatório
async function publishReport(reportId) {
    const report = reports.find(r => r.id === reportId);
    if (!report) return;
    
    try {
        const response = await fetch('/api/publish/report', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: report.name,
                public: document.getElementById('togglePublic').checked,
                password: document.getElementById('accessPassword').value
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'ok') {
            // Atualizar relatório
            report.status = 'published';
            report.shareId = data.publish.share_id;
            
            // Mostrar modal
            document.getElementById('modalShareLink').value = `${window.location.origin}${data.publish.share_url}`;
            document.getElementById('modalEmbedCode').value = data.publish.embed_code;
            document.getElementById('publishModal').classList.add('active');
            
            // Re-renderizar
            renderReports();
            renderPublished();
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao publicar relatório');
    }
}

// Renderizar publicações recentes
function renderPublished() {
    const container = document.getElementById('publishedList');
    const published = reports.filter(r => r.status === 'published');
    
    container.innerHTML = published.map(r => `
        <div class="published-item">
            <div class="published-info">
                <i class="fas fa-check-circle"></i>
                <div>
                    <div class="published-name">${r.name}</div>
                    <div class="published-date">${r.updated}</div>
                </div>
            </div>
            <div class="published-actions">
                <button class="action-btn" title="Copiar Link" onclick="copyReportLink('${r.shareId}')">
                    <i class="fas fa-link"></i>
                </button>
                <button class="action-btn" title="Abrir" onclick="window.open('/shared/${r.shareId}')">
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <button class="action-btn" title="Despublicar">
                    <i class="fas fa-eye-slash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Tipo de compartilhamento
document.querySelectorAll('.share-option').forEach(opt => {
    opt.onclick = () => {
        document.querySelectorAll('.share-option').forEach(o => o.classList.remove('active'));
        opt.classList.add('active');
        
        const type = opt.dataset.type;
        document.getElementById('embedSection').style.display = type === 'embed' ? 'block' : 'none';
    };
});

// Toggle senha
function togglePasswordSection() {
    const section = document.getElementById('passwordSection');
    section.classList.toggle('active', document.getElementById('togglePassword').checked);
}

// Copiar funções
function copyLink() {
    const input = document.getElementById('shareLink');
    input.select();
    document.execCommand('copy');
    showToast('Link copiado!');
}

function copyEmbed() {
    const code = document.getElementById('embedCode').textContent;
    navigator.clipboard.writeText(code);
    showToast('Código copiado!');
}

function copyModalLink() {
    const input = document.getElementById('modalShareLink');
    input.select();
    document.execCommand('copy');
    showToast('Link copiado!');
}

function copyModalEmbed() {
    const input = document.getElementById('modalEmbedCode');
    navigator.clipboard.writeText(input.value);
    showToast('Código copiado!');
}

function copyReportLink(shareId) {
    navigator.clipboard.writeText(`${window.location.origin}/shared/${shareId}`);
    showToast('Link copiado!');
}

// Toast notification
function showToast(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--accent-color);
        color: white;
        padding: 12px 25px;
        border-radius: 8px;
        z-index: 2000;
        animation: slideUp 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 2000);
}

// Modal
function closePublishModal() {
    document.getElementById('publishModal').classList.remove('active');
}

// Inicializar
renderReports();
renderPublished();
</script>

<style>
@keyframes slideUp {
    from { opacity: 0; transform: translateX(-50%) translateY(20px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
}
</style>
{% endblock %}
